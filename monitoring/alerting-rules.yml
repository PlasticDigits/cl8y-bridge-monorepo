# Alerting rules for CL8Y Bridge

groups:
  - name: cl8y-bridge-alerts
    rules:
      # Operator is down
      - alert: OperatorDown
        expr: up{job="cl8y-operator"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "CL8Y Bridge Operator is down"
          description: "The operator has been unreachable for more than 2 minutes."

      # High error rate
      - alert: HighErrorRate
        expr: rate(relayer_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on {{ $labels.chain }}"
          description: "Error rate is {{ $value | humanize }} errors/sec"

      # Circuit breaker tripped
      - alert: CircuitBreakerTripped
        expr: relayer_consecutive_failures > 5
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Circuit breaker triggered for {{ $labels.chain }}"
          description: "{{ $value }} consecutive failures detected"

      # No deposits processed in a while
      - alert: NoDepositsProcessed
        expr: increase(relayer_deposits_detected_total[30m]) == 0
        for: 30m
        labels:
          severity: info
        annotations:
          summary: "No deposits detected on {{ $labels.chain }}"
          description: "No new deposits detected in the last 30 minutes. This may be normal during low activity."

      # High pending queue
      - alert: HighPendingQueue
        expr: relayer_pending_approvals > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High pending approval queue on {{ $labels.chain }}"
          description: "{{ $value }} approvals pending processing"

      # Stale last successful poll
      - alert: StalePolling
        expr: time() - relayer_last_successful_poll_timestamp > 300
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Polling stalled for {{ $labels.chain }}"
          description: "No successful poll in over 5 minutes"

  # Canceler-specific alerts
  - name: cl8y-canceler-alerts
    rules:
      # Canceler is down
      - alert: CancelerDown
        expr: up{job="cl8y-cancelers"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Canceler {{ $labels.instance }} is down"
          description: "The canceler has been unreachable for more than 2 minutes. Fraud detection may be compromised."

      # Canceler not processing blocks
      - alert: CancelerNotProcessingBlocks
        expr: increase(canceler_last_evm_block[5m]) == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Canceler {{ $labels.canceler_id }} not processing EVM blocks"
          description: "No new EVM blocks processed in 5 minutes. Fraud detection may be delayed."

      # Canceler not processing Terra
      - alert: CancelerNotProcessingTerra
        expr: increase(canceler_last_terra_height[5m]) == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Canceler {{ $labels.canceler_id }} not processing Terra blocks"
          description: "No new Terra blocks processed in 5 minutes."

      # Cancellation submitted (security event)
      - alert: CancellationSubmitted
        expr: increase(canceler_cancelled_count[5m]) > 0
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "Fraudulent approval cancelled by {{ $labels.canceler_id }}"
          description: "A fraudulent approval was detected and cancelled. Investigate the source."

      # High cancellation rate (possible attack)
      - alert: HighCancellationRate
        expr: increase(canceler_cancelled_count[1h]) > 5
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "High cancellation rate detected"
          description: "{{ $value }} cancellations in the last hour. Possible attack in progress."

      # All cancelers down
      - alert: AllCancelersDown
        expr: count(up{job="cl8y-cancelers"} == 1) == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ALL CANCELERS DOWN - CRITICAL"
          description: "No cancelers are running. Bridge is vulnerable to fraud. PAUSE BRIDGE IMMEDIATELY."

      # Insufficient cancelers (below minimum)
      - alert: InsufficientCancelers
        expr: count(up{job="cl8y-cancelers"} == 1) < 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Insufficient cancelers running"
          description: "Only {{ $value }} canceler(s) running. Minimum 2 recommended for production."

      # Canceler health check failing
      - alert: CancelerUnhealthy
        expr: canceler_health_status != 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Canceler {{ $labels.canceler_id }} unhealthy"
          description: "Canceler reporting unhealthy status. Check logs for details."
