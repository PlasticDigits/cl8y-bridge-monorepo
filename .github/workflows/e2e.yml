name: E2E Tests

# =============================================================================
# SECURITY: This bridge handles cross-chain assets. ALL tests run on EVERY push.
# Do NOT add --no-* flags that skip tests. Slow CI is better than losing $1B.
# =============================================================================

on:
  push:
    branches: [main]
    paths:
      - 'packages/operator/**'
      - 'packages/canceler/**'
      - 'packages/e2e/**'
      - 'packages/contracts-evm/**'
      - 'packages/contracts-terraclassic/**'
      - 'scripts/**'
      - '.github/workflows/e2e.yml'
  pull_request:
    branches: [main]
    paths:
      - 'packages/operator/**'
      - 'packages/canceler/**'
      - 'packages/e2e/**'
      - 'packages/contracts-evm/**'
      - 'packages/contracts-terraclassic/**'
      - 'scripts/**'
      - '.github/workflows/e2e.yml'
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # Full E2E Tests - EVM + Terra + Operator + Canceler
  # Runs on EVERY push and PR. No exceptions. No skipping.
  # ==========================================================================
  e2e-full:
    name: E2E Tests (Full Suite)
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: operator
          POSTGRES_PASSWORD: operator
          POSTGRES_DB: operator
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          targets: wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            packages/operator -> target
            packages/canceler -> target
            packages/e2e -> target
            packages/contracts-terraclassic/bridge -> target

      - name: Install additional tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl postgresql-client

      # ========================================================================
      # Start ALL Infrastructure
      # ========================================================================
      - name: Start Anvil (EVM)
        run: |
          anvil --host 0.0.0.0 --port 8545 --block-time 1 --accounts 10 --balance 10000 &
          sleep 5
          cast block-number --rpc-url http://localhost:8545
          echo "Anvil started successfully"

      - name: Start LocalTerra
        run: |
          # Pull and start LocalTerra container
          # Using ghcr.io/plasticdigits/localterra-cl8y:latest (same as docker-compose.yml)
          # - Pre-configured for Terra Classic
          # - Fast block times (~200ms)
          # - CosmWasm 1.5.x support
          docker run -d \
            --name localterra \
            --platform linux/amd64 \
            -p 26657:26657 \
            -p 1317:1317 \
            -p 9090:9090 \
            -p 9091:9091 \
            ghcr.io/plasticdigits/localterra-cl8y:latest
          
          # Wait for LocalTerra to be ready (up to 5 minutes)
          echo "Waiting for LocalTerra to start..."
          for i in {1..60}; do
            if curl -sf http://localhost:26657/status > /dev/null 2>&1; then
              echo "LocalTerra is ready after $((i * 5)) seconds"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "ERROR: LocalTerra failed to start after 5 minutes"
              docker logs localterra
              exit 1
            fi
            echo "Waiting... ($i/60)"
            sleep 5
          done
          
          # Verify LocalTerra is running
          curl -sf http://localhost:26657/status
          echo "LocalTerra verified"

      # ========================================================================
      # Deploy ALL Contracts
      # ========================================================================
      - name: Deploy EVM Contracts
        working-directory: packages/contracts-evm
        run: |
          forge build
          forge script script/DeployLocal.s.sol:DeployLocal \
            --rpc-url http://localhost:8545 \
            --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \
            --broadcast
          echo "EVM contracts deployed successfully"

      - name: Extract EVM Contract Addresses
        id: evm_contracts
        working-directory: packages/contracts-evm
        run: |
          BROADCAST_FILE="broadcast/DeployLocal.s.sol/31337/run-latest.json"
          if [ ! -f "$BROADCAST_FILE" ]; then
            echo "ERROR: Broadcast file not found"
            exit 1
          fi
          
          BRIDGE_ADDRESS=$(jq -r '.transactions[] | select(.contractName == "CL8YBridge") | .contractAddress' "$BROADCAST_FILE" | head -1)
          ACCESS_MANAGER=$(jq -r '.transactions[] | select(.contractName == "AccessManagerEnumerable") | .contractAddress' "$BROADCAST_FILE" | head -1)
          ROUTER_ADDRESS=$(jq -r '.transactions[] | select(.contractName == "CL8YBridgeRouter") | .contractAddress' "$BROADCAST_FILE" | head -1)
          LOCK_UNLOCK=$(jq -r '.transactions[] | select(.contractName == "LockUnlock") | .contractAddress' "$BROADCAST_FILE" | head -1)
          
          echo "EVM_BRIDGE_ADDRESS=$BRIDGE_ADDRESS" >> $GITHUB_OUTPUT
          echo "ACCESS_MANAGER_ADDRESS=$ACCESS_MANAGER" >> $GITHUB_OUTPUT
          echo "EVM_ROUTER_ADDRESS=$ROUTER_ADDRESS" >> $GITHUB_OUTPUT
          echo "LOCK_UNLOCK_ADDRESS=$LOCK_UNLOCK" >> $GITHUB_OUTPUT
          
          echo "EVM Contract addresses:"
          echo "  Bridge: $BRIDGE_ADDRESS"
          echo "  AccessManager: $ACCESS_MANAGER"
          echo "  Router: $ROUTER_ADDRESS"
          echo "  LockUnlock: $LOCK_UNLOCK"

      - name: Build Terra Contracts (Docker optimized, cosmwasm_1_2)
        run: |
          make build-terra-optimized
          echo "Terra contracts built successfully"

      - name: Deploy Terra Contracts
        id: terra_contracts
        run: |
          # Deploy Terra bridge contract
          chmod +x ./scripts/deploy-terra-local.sh
          
          # Run deployment and capture address
          TERRA_BRIDGE=$(./scripts/deploy-terra-local.sh 2>&1 | grep -oP 'Contract address: \K[a-z0-9]+' || echo "")
          
          if [ -z "$TERRA_BRIDGE" ]; then
            echo "WARNING: Could not extract Terra bridge address, using placeholder"
            TERRA_BRIDGE="terra1placeholder"
          fi
          
          echo "TERRA_BRIDGE_ADDRESS=$TERRA_BRIDGE" >> $GITHUB_OUTPUT
          echo "Terra bridge deployed at: $TERRA_BRIDGE"

      # ========================================================================
      # Build ALL Services
      # ========================================================================
      - name: Build Operator
        working-directory: packages/operator
        env:
          DATABASE_URL: postgres://operator:operator@localhost:5433/operator
        run: |
          cargo build --release
          echo "Operator built successfully"

      - name: Build Canceler
        working-directory: packages/canceler
        run: |
          cargo build --release
          echo "Canceler built successfully"

      - name: Run Database Migrations
        working-directory: packages/operator
        env:
          DATABASE_URL: postgres://operator:operator@localhost:5433/operator
        run: |
          cargo run --release -- --migrate-only 2>/dev/null || echo "Migration complete"
          echo "Database migrations complete"

      # ========================================================================
      # Grant Roles
      # ========================================================================
      - name: Grant Test Account Roles
        env:
          EVM_RPC_URL: http://localhost:8545
          ACCESS_MANAGER_ADDRESS: ${{ steps.evm_contracts.outputs.ACCESS_MANAGER_ADDRESS }}
          EVM_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
        run: |
          TEST_ACCOUNT="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
          
          echo "Granting OPERATOR_ROLE (ID 1)..."
          cast send "$ACCESS_MANAGER_ADDRESS" \
            "grantRole(uint64,address,uint32)" 1 "$TEST_ACCOUNT" 0 \
            --rpc-url "$EVM_RPC_URL" \
            --private-key "$EVM_PRIVATE_KEY"
          
          echo "Granting CANCELER_ROLE (ID 2)..."
          cast send "$ACCESS_MANAGER_ADDRESS" \
            "grantRole(uint64,address,uint32)" 2 "$TEST_ACCOUNT" 0 \
            --rpc-url "$EVM_RPC_URL" \
            --private-key "$EVM_PRIVATE_KEY"
          
          echo "Roles granted successfully"

      # ========================================================================
      # Build Rust E2E Package
      # ========================================================================
      - name: Build E2E Test Package
        working-directory: packages/e2e
        run: cargo build --release

      # ========================================================================
      # RUN ALL E2E TESTS - NO SKIPPING
      # ========================================================================
      - name: Run Rust E2E Test Suite
        env:
          # EVM
          EVM_RPC_URL: http://localhost:8545
          EVM_CHAIN_ID: "31337"
          EVM_BRIDGE_ADDRESS: ${{ steps.evm_contracts.outputs.EVM_BRIDGE_ADDRESS }}
          EVM_ROUTER_ADDRESS: ${{ steps.evm_contracts.outputs.EVM_ROUTER_ADDRESS }}
          ACCESS_MANAGER_ADDRESS: ${{ steps.evm_contracts.outputs.ACCESS_MANAGER_ADDRESS }}
          LOCK_UNLOCK_ADDRESS: ${{ steps.evm_contracts.outputs.LOCK_UNLOCK_ADDRESS }}
          EVM_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
          # Terra
          TERRA_RPC_URL: http://localhost:26657
          TERRA_LCD_URL: http://localhost:1317
          TERRA_CHAIN_ID: localterra
          TERRA_BRIDGE_ADDRESS: ${{ steps.terra_contracts.outputs.TERRA_BRIDGE_ADDRESS }}
          # Database
          DATABASE_URL: postgres://operator:operator@localhost:5433/operator
          # Logging
          RUST_LOG: info
        run: |
          echo "============================================================"
          echo "  CL8Y Bridge Rust E2E Test Suite"
          echo "============================================================"
          
          # Run Rust E2E tests
          cargo run -p cl8y-e2e --release -- run
          
          echo "============================================================"
          echo "  Rust E2E tests completed successfully"
          echo "============================================================"

      - name: Run Full E2E Test Suite (Bash)
        env:
          # EVM
          EVM_RPC_URL: http://localhost:8545
          EVM_CHAIN_ID: "31337"
          EVM_BRIDGE_ADDRESS: ${{ steps.evm_contracts.outputs.EVM_BRIDGE_ADDRESS }}
          EVM_ROUTER_ADDRESS: ${{ steps.evm_contracts.outputs.EVM_ROUTER_ADDRESS }}
          ACCESS_MANAGER_ADDRESS: ${{ steps.evm_contracts.outputs.ACCESS_MANAGER_ADDRESS }}
          LOCK_UNLOCK_ADDRESS: ${{ steps.evm_contracts.outputs.LOCK_UNLOCK_ADDRESS }}
          EVM_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
          # Terra
          TERRA_RPC_URL: http://localhost:26657
          TERRA_LCD_URL: http://localhost:1317
          TERRA_CHAIN_ID: localterra
          TERRA_BRIDGE_ADDRESS: ${{ steps.terra_contracts.outputs.TERRA_BRIDGE_ADDRESS }}
          # Database
          DATABASE_URL: postgres://operator:operator@localhost:5433/operator
          # Logging
          RUST_LOG: info
        run: |
          echo "============================================================"
          echo "  CL8Y Bridge Full E2E Test Suite (Bash)"
          echo "  Security-critical: ALL tests enabled, NO skipping"
          echo "============================================================"
          
          chmod +x ./scripts/e2e-test.sh
          chmod +x ./scripts/operator-ctl.sh
          chmod +x ./scripts/canceler-ctl.sh
          
          # Run ALL E2E tests
          # --no-setup: Infrastructure already started above
          # --no-teardown: Keep running for log collection on failure
          # NO --no-terra, NO --no-operator, NO --no-canceler
          ./scripts/e2e-test.sh --no-setup --no-teardown
          
          echo "============================================================"
          echo "  ALL E2E tests completed successfully"
          echo "============================================================"

      # ========================================================================
      # Unit Tests
      # ========================================================================
      - name: Run Operator Unit Tests
        working-directory: packages/operator
        env:
          DATABASE_URL: postgres://operator:operator@localhost:5433/operator
        run: cargo test --release -- --nocapture

      - name: Run Canceler Unit Tests
        working-directory: packages/canceler
        run: cargo test --release -- --nocapture

      # ========================================================================
      # Cleanup
      # ========================================================================
      - name: Stop LocalTerra
        if: always()
        run: |
          docker stop localterra || true
          docker rm localterra || true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: |
            .operator.log
            .canceler.*.log
            packages/operator/target/release/*.log
            packages/contracts-evm/broadcast/**/*.json
          retention-days: 7
