name: E2E Tests

on:
  push:
    branches: [main]
    paths:
      - 'packages/operator/**'
      - 'packages/contracts-evm/**'
      - 'scripts/**'
      - '.github/workflows/e2e.yml'
  pull_request:
    branches: [main]
    paths:
      - 'packages/operator/**'
      - 'packages/contracts-evm/**'
      - 'scripts/**'
      - '.github/workflows/e2e.yml'
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: operator
          POSTGRES_PASSWORD: operator
          POSTGRES_DB: operator
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/operator -> target

      - name: Cache Docker images
        uses: satackey/action-docker-layer-caching@v0.0.11
        continue-on-error: true

      - name: Install additional tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl postgresql-client

      - name: Start Anvil
        run: |
          anvil --host 0.0.0.0 --port 8545 --block-time 1 --accounts 10 --balance 10000 &
          sleep 5
          # Verify Anvil is running
          cast block-number --rpc-url http://localhost:8545

      - name: Deploy EVM Contracts
        working-directory: packages/contracts-evm
        run: |
          forge build
          forge script script/DeployLocal.s.sol:DeployLocal \
            --rpc-url http://localhost:8545 \
            --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \
            --broadcast

      - name: Extract Contract Addresses
        id: contracts
        working-directory: packages/contracts-evm
        run: |
          BROADCAST_FILE="broadcast/DeployLocal.s.sol/31337/run-latest.json"
          if [ -f "$BROADCAST_FILE" ]; then
            BRIDGE_ADDRESS=$(jq -r '.transactions[] | select(.contractName == "CL8YBridge") | .contractAddress' "$BROADCAST_FILE" | head -1)
            echo "EVM_BRIDGE_ADDRESS=$BRIDGE_ADDRESS" >> $GITHUB_OUTPUT
            echo "Bridge deployed at: $BRIDGE_ADDRESS"
          fi

      - name: Build Operator
        working-directory: packages/operator
        env:
          DATABASE_URL: postgres://operator:operator@localhost:5433/operator
        run: |
          cargo build --release

      - name: Run Database Migrations
        working-directory: packages/operator
        env:
          DATABASE_URL: postgres://operator:operator@localhost:5433/operator
        run: |
          cargo run --release -- --migrate-only || true

      - name: Run E2E Tests
        env:
          EVM_RPC_URL: http://localhost:8545
          EVM_CHAIN_ID: 31337
          EVM_BRIDGE_ADDRESS: ${{ steps.contracts.outputs.EVM_BRIDGE_ADDRESS }}
          EVM_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
          DATABASE_URL: postgres://operator:operator@localhost:5433/operator
          TERRA_RPC_URL: ""
          TERRA_LCD_URL: ""
          TERRA_BRIDGE_ADDRESS: ""
          RUST_LOG: info
        run: |
          # Run operator in background
          cd packages/operator
          timeout 60 cargo run --release &
          OPERATOR_PID=$!
          sleep 10
          
          # Run a basic health check
          curl -sf http://localhost:9090/health || echo "Health check failed (operator may not have started)"
          
          # Kill operator
          kill $OPERATOR_PID 2>/dev/null || true
          
          echo "E2E basic test completed"

      - name: Run Unit Tests
        working-directory: packages/operator
        env:
          DATABASE_URL: postgres://operator:operator@localhost:5433/operator
        run: |
          cargo test --release -- --nocapture

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: |
            packages/operator/target/release/*.log
            packages/contracts-evm/broadcast/**/*.json
          retention-days: 7
