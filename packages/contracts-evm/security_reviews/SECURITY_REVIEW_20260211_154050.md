# Security Review: contracts-evm Package

**Date:** 2026-02-11 (UTC)  
**Epoch:** 20260211_154050  
**Reviewer:** Security Review  
**Package:** `packages/contracts-evm`

---

## Executive Summary

This document provides a full security review of the contracts-evm package in its current state. The bridge implements a cross-chain asset transfer system with user-initiated withdrawals, operator approvals, and a canceler role for withdrawal cancellation within a time window.

### Remediation Status (since prior review 20260211_060738)

| Finding | Status |
|---------|--------|
| RBAC deviation (operators had admin privileges) | ✅ Fixed – Fee/chain/token config now `onlyOwner` |
| `depositNative` when wrappedNative not set | ✅ Fixed – Reverts with `WrappedNativeNotSet` |
| Missing `depositNative` tests | ✅ Fixed – 5 tests added |
| Missing `withdrawExecuteMint` test | ✅ Fixed – Full flow test added |

### Key Findings Summary (current state)

| Severity | Count | Summary |
|----------|-------|---------|
| High | 0 | — |
| Medium | 0 | — |
| Low/Info | 3 | Operational notes (one doc fix applied) |

---

## 1. Test Coverage

### 1.1 Coverage Overview

- **Total test suites:** 17 (includes BridgeInvariantTest)
- **Total tests:** 333+ passing (includes 4 invariant tests)
- **Bridge tests:** 41 (includes depositNative, withdrawExecuteMint, withdrawExecuteUnlock)
- **Bridge invariants:** 4 (depositNonce, thisChainId, cancelWindow, registries)

### 1.2 Per-Contract Test Status

| Contract | Tests | Status |
|----------|-------|--------|
| Bridge | 41 | ✅ Excellent |
| ChainRegistry | 18 | ✅ Good |
| TokenRegistry | 14 | ✅ Good |
| LockUnlock | 8 | ✅ Adequate |
| MintBurn | 7 | ✅ Adequate |
| GuardBridge | 9 | ✅ Good |
| BlacklistBasic | 7 | ✅ Adequate |
| TokenRateLimit | 11 | ✅ Good |
| HashLib | 38 | ✅ Excellent |
| FeeCalculatorLib | 32 | ✅ Good |
| BridgeInvariantTest | 4 | ✅ Implemented |
| Others | Various | ✅ Adequate |

### 1.3 Test Coverage Gaps

1. **Guard–Bridge integration** – Documented in OPERATIONAL_NOTES.md §6. GuardBridge is tested in isolation; integration with the main Bridge is optional.
2. **Create3Deployer** – TODO for future (OPERATIONAL_NOTES.md §7). Standard Solady CREATE3 wrapper.

---

## 2. Top Common Solidity Issues

### 2.1 Reentrancy ✅

- **Bridge:** Uses `ReentrancyGuard` and `nonReentrant` on all deposit/withdraw entry points.
- **LockUnlock / MintBurn:** Use `ReentrancyGuard` on `lock`, `unlock`, `burn`, `mint`.
- **ETH transfers:** Fee and `operatorGas` transfers occur after state updates; `nonReentrant` prevents reentrancy.

**Verdict:** Reentrancy protections are in place.

### 2.2 Integer Overflow / Underflow ✅

- Solidity `^0.8.30` provides built-in checks.
- No unsafe `unchecked` usage in critical paths.

**Verdict:** No issues identified.

### 2.3 Access Control ✅

- **Admin (onlyOwner):** `pause`, `unpause`, `setWrappedNative`, `setCancelWindow`, `addOperator`, `removeOperator`, `addCanceler`, `removeCanceler`, `setFeeParams`, `setCustomAccountFee`, `removeCustomAccountFee`, upgrades. Chain/token registration in registries.
- **Operator (onlyOperator):** `withdrawApprove`, `withdrawUncancel` only.
- **Canceler (onlyCanceler):** `withdrawCancel` only.
- **Public:** `deposit*`, `withdrawSubmit`, `withdrawExecute*`.

**Verdict:** RBAC aligns with the design.

### 2.4 Unchecked Low-Level Calls ✅

- Fee and `operatorGas` transfers use `call` with `require(success)`.
- External value transfers are guarded.

**Verdict:** No issues identified.

### 2.5 Front-Running ✅

- `withdrawSubmit` and `withdrawExecute*` are permissionless by design; recipient is derived from `destAccount`.
- No vulnerability from front-running identified.

### 2.6 Token Assumptions ✅ Documented

- **Rebasing / fee-on-transfer:** Not supported; LockUnlock/MintBurn balance checks document this.
- **Status:** Documented in OPERATIONAL_NOTES.md §4.

---

## 3. Flows

### 3.1 Deposit Flow

1. **depositERC20 / depositERC20Mintable**  
   - Validates token and chain; calculates fee; locks or burns; stores deposit record; emits event.

2. **depositNative**  
   - Reverts if `wrappedNative == address(0)`.
   - Reverts if `wrappedNative` is not registered (`TokenNotRegistered`).
   - Reverts if dest mapping for `wrappedNative` and `destChain` is not set (`DestTokenMappingNotSet`).
   - Validates amount, chain; transfers fee; stores net amount in Bridge; records deposit with `token: wrappedNative`.

### 3.2 Withdraw Flow

1. **withdrawSubmit** (public) – Creates `PendingWithdraw`.
2. **withdrawApprove** (operator) – Marks approved, pays `operatorGas`.
3. **withdrawCancel** (canceler) – Cancels within window.
4. **withdrawUncancel** (operator) – Restores and restarts window.
5. **withdrawExecuteUnlock / withdrawExecuteMint** (public) – Executes after window.

### 3.3 Hash Consistency

- `HashLib.computeTransferHash` used consistently on deposit and withdraw.
- Correct alignment for cross-chain matching.

---

## 4. Access Control (RBAC)

### 4.1 Current Implementation

#### Bridge

| Function | Access | Status |
|----------|--------|--------|
| `pause`, `unpause` | onlyOwner | ✅ |
| `setWrappedNative`, `setCancelWindow` | onlyOwner | ✅ |
| `addOperator`, `removeOperator` | onlyOwner | ✅ |
| `addCanceler`, `removeCanceler` | onlyOwner | ✅ |
| `setFeeParams`, `setCustomAccountFee`, `removeCustomAccountFee` | onlyOwner | ✅ |
| `withdrawApprove`, `withdrawUncancel` | onlyOperator | ✅ |
| `withdrawCancel` | onlyCanceler | ✅ |
| `deposit*`, `withdrawSubmit`, `withdrawExecute*` | Public | ✅ |
| `upgradeToAndCall` | onlyOwner | ✅ |

#### ChainRegistry / TokenRegistry

- All registration and config: `onlyOwner`. No operators or cancelers.

---

## 5. Additional Findings

### 5.1 Cancel Window Boundary – Documentation vs. Implementation ✅ Resolved

**Location:** `Bridge.sol` `_validateWithdrawExecution`, OPERATIONAL_NOTES.md §3

**Status:** Fixed. OPERATIONAL_NOTES.md §3 now states that execution is allowed when `block.timestamp > windowEnd` (exclusive), matching the implementation.

### 5.2 Fee Recipient Must Accept ETH (Low) ✅ Documented

**Location:** `Bridge.sol` – `depositNative`, `setFeeParams`

**Status:** Documented in OPERATIONAL_NOTES.md §1. `feeRecipient` must accept plain ETH (EOA or compatible contract).

### 5.3 Guard Module State Mutations (Low) ✅ Documented

**Location:** `TokenRateLimit.sol` – `checkDeposit`, `checkWithdraw`

**Status:** Documented in OPERATIONAL_NOTES.md §2. Guard check functions may mutate state.

### 5.4 withdrawExecuteUnlock vs withdrawExecuteMint – Caller Responsibility (Info)

**Location:** `Bridge.sol` – `withdrawExecuteUnlock`, `withdrawExecuteMint`

**Observation:** The Bridge does not route based on token type. The caller (recipient or relayer) must invoke the correct function: `withdrawExecuteUnlock` for LockUnlock tokens, `withdrawExecuteMint` for MintBurn tokens.

**Impact:** Calling the wrong function reverts (e.g., mint on non-mintable token, unlock when LockUnlock has no balance). No security impact; UX concern for integrators.

**Status:** Document as integrator requirement if not already.

### 5.5 Create3Deployer Coverage (Info)

**Observation:** `Create3Deployer` has minimal direct test coverage.

**Status:** Marked TODO in OPERATIONAL_NOTES.md §7. Standard infrastructure; deployment script verification deferred.

---

## 6. Recommendations Summary

### Low

1. ~~**Fix cancel window boundary documentation**~~ – ✅ Resolved. OPERATIONAL_NOTES.md §3 updated.

### Informational

2. **withdrawExecute* routing** – Document that integrators must call `withdrawExecuteUnlock` or `withdrawExecuteMint` based on token type; calling the wrong one will revert.
3. **Guard–Bridge integration tests** – Documented as optional; deferred if guards adopted.
4. **Create3Deployer** – TODO for future (OPERATIONAL_NOTES.md §7).

---

## 7. Appendix: Contract Inventory

| Contract | Purpose |
|----------|---------|
| Bridge | Main bridge: deposits, withdrawals, approvals, cancel |
| ChainRegistry | Chain ID and identifier registry |
| TokenRegistry | Token registration and per-chain mappings |
| LockUnlock | Lock/unlock ERC20 for LockUnlock tokens |
| MintBurn | Burn/mint for MintBurn tokens |
| GuardBridge | Composable guard orchestration |
| BlacklistBasic | Account blacklist guard |
| TokenRateLimit | Per-token 24h rate limits |
| AccessManagerEnumerable | Extended AccessManager with enumeration |
| DatastoreSetAddress | Generic address set storage |
| FactoryTokenCl8yBridged | Bridged token factory |
| TokenCl8yBridged | Bridged ERC20 implementation |
| HashLib | Transfer hash and encoding utilities |
| FeeCalculatorLib | Fee calculation (standard, discounted, custom) |
| AddressCodecLib | Address encoding/decoding for Cosmos/EVM |
| Create3Deployer | Deterministic deployment support |

---

## 8. Changelog vs. Prior Review (20260211_060738)

| Item | Before | After |
|------|--------|-------|
| New findings | — | Cancel window doc inconsistency (Low), withdrawExecute* caller responsibility (Info) |
| High findings | 0 | 0 |
| Medium findings | 0 | 0 |
| Low/Info findings | 6 | 4 (consolidated, one new doc fix) |

---

*End of Security Review*
