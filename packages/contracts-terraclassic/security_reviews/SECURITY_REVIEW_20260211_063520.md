# Security Review: contracts-terraclassic Package

**Date:** 2026-02-11 (UTC)  
**Epoch:** 20260211_063520  
**Reviewer:** Security Review  
**Package:** `packages/contracts-terraclassic` (bridge CosmWasm contract)

---

## Executive Summary

This document provides a full security review of the contracts-terraclassic package. The bridge is a CosmWasm contract implementing a cross-chain asset transfer system with user-initiated withdrawals, operator approvals, and a canceler role (watchtower pattern). It runs on Terra Classic and interfaces with EVM chains.

### Key Findings Summary

| Severity | Count | Summary |
|----------|-------|---------|
| High | 0 | â€” (cancel window fixed) |
| Medium | 0 | â€” (RBAC deviations fixed) |
| Low/Info | 6 | Recommendations and hardening opportunities |

*Remediation (2026-02-11): Cancel window now uses WITHDRAW_DELAY; WithdrawCancel restricted to cancelers; SetCustomAccountFee/RemoveCustomAccountFee restricted to admin.*

---

## 1. Test Coverage

### 1.1 Coverage Overview

- **Total test files:** 7
- **Test areas:** Withdraw flow, integration, chain registry, incoming token registry, fee system, hash parity, address codec

### 1.2 Per-Module Test Status

| Module/Flow | Tests | Status |
|-------------|-------|--------|
| Withdraw flow (V2) | ~30+ tests | âœ… Excellent â€“ full lifecycle, cancel/uncancel, edge cases |
| Integration | 17 tests | âœ… Good â€“ instantiation, submit/approve/cancel/execute |
| Chain registry | Multiple | âœ… Good â€“ register, unregister, enable/disable |
| Incoming token registry | Multiple | âœ… Good â€“ mapping, validation |
| Fee system | Multiple | âœ… Adequate |
| Hash parity | Multiple | âœ… Excellent â€“ cross-chain hash consistency |
| Address codec | Unit tests | âœ… Adequate |
| Outgoing (deposit) | Limited | âš ï¸ Partial â€“ `test_lock_stores_xchain_hash_id` only |

### 1.3 Test Coverage Gaps

1. **Deposit flows under-tested** â€“ No comprehensive tests for `DepositNative` min/max limits, fee calculation, rate limits, or CW20 deposit (lock/burn) with edge cases.

2. **Admin/recovery flows** â€“ No tests for `RecoverAsset`, `ProposeAdmin`/`AcceptAdmin` timelock, or paused-state behavior beyond basic pause checks.

3. **Rate limit enforcement** â€“ Tests configure rate limits but do not verify that withdrawals actually enforce per-transaction and per-period limits in `WithdrawExecuteUnlock`/`WithdrawExecuteMint`.

4. **MintBurn execute** â€“ `test_execute_unlock_wrong_token_type_rejected` validates LockUnlock vs MintBurn, but there is no full-flow test for `WithdrawExecuteMint` with actual CW20 mint.

5. **Operator authorization** â€“ Tests verify operator can approve and user cannot; no negative tests for canceler-only scenarios (e.g., operator trying to cancel when design says only canceler).

6. **Migration** â€“ No tests for `migrate` entry point (v1â†’v2 WITHDRAW_DELAY and FEE_CONFIG initialization).

---

## 2. Access Control (RBAC)

### 2.1 Desired RBAC Model (per requirements)

| Role | Level | Permissions |
|------|-------|-------------|
| Admin | 0 | System variables, chain/token registration, pause, operators, cancelers |
| Operator | 1 | **Solely** `WithdrawApprove` (and `WithdrawUncancel`) |
| Canceler | 2 | **Solely** `WithdrawCancel` |
| Public | â€” | Deposit, Withdraw (submit + execute) |

### 2.2 Implemented vs Desired

| Message | Desired | Implemented | Status |
|---------|---------|-------------|--------|
| Pause / Unpause | Admin | Admin | âœ… |
| RegisterChain, AddToken, etc. | Admin | Admin | âœ… |
| AddCanceler / RemoveCanceler | Admin | Admin | âœ… |
| SetWithdrawDelay, SetRateLimit | Admin | Admin | âœ… |
| AddOperator / RemoveOperator | Admin | Admin | âœ… |
| UpdateLimits, UpdateFees, SetFeeParams | Admin | Admin | âœ… |
| **WithdrawApprove** | Operator only | Operator **or Admin** | âš ï¸ Operator + Admin |
| **WithdrawUncancel** | Operator only | Operator **or Admin** | âš ï¸ Operator + Admin |
| **WithdrawCancel** | Canceler only | Canceler only | âœ… Fixed |
| **SetCustomAccountFee** | Admin | Admin only | âœ… Fixed |
| **RemoveCustomAccountFee** | Admin | Admin only | âœ… Fixed |
| DepositNative, Receive | Public | Public | âœ… |
| WithdrawSubmit | Public | Public | âœ… |
| WithdrawExecuteUnlock / Mint | Public | Public | âœ… |

### 2.3 RBAC Findings

1. **WithdrawApprove / WithdrawUncancel allow Admin** â€“ Design states operator *solely* for these. Allowing admin is a convenience but expands the operator-equivalent trust surface. **Recommendation:** Document as intentional (admin can act as backup operator) or restrict to operators only.

2. **WithdrawCancel** â€“ Now restricted to cancelers only. Operators and admin cannot cancel.

3. **SetCustomAccountFee / RemoveCustomAccountFee** â€“ Now restricted to admin only.

---

## 3. Flows

### 3.1 Deposit Flow (Outgoing)

1. User calls `DepositNative` or sends CW20 via `Receive(DepositCw20Lock/DepositCw20MintableBurn)`.
2. Contract validates: paused, chain, token, amount limits, fee calculation.
3. Tokens are locked (LockUnlock) or burned (MintBurn); fee sent to collector; deposit hash stored.
4. Nonce incremented; transaction and deposit info persisted.

**Observations:**
- Amount limits (`min_bridge_amount`, `max_bridge_amount`) enforced. âœ…
- Fee uses V2 fee manager (CL8Y discount, custom account fees). âœ…
- No rate limit on deposits (only on withdrawals). âš ï¸ Consider symmetric limits if desired.

### 3.2 Withdrawal Flow (V2 â€“ Incoming)

1. **WithdrawSubmit** â€“ User submits params (src_chain, src_account, token, recipient, amount, nonce). Creates `PendingWithdraw`; optional operator gas tip.
2. **WithdrawApprove** â€“ Operator (or admin) approves; marks nonce used; starts cancel window; transfers operator gas to approver.
3. **WithdrawCancel** â€“ Canceler (or operator or admin) cancels within cancel window.
4. **WithdrawUncancel** â€“ Operator (or admin) restores cancelled withdrawal and resets cancel window.
5. **WithdrawExecuteUnlock / WithdrawExecuteMint** â€“ Anyone executes after cancel window; releases tokens (unlock or mint).

**Observations:**
- Nonce reuse prevented via `WITHDRAW_NONCE_USED`. âœ…
- Cancel window enforced before execute. âœ…
- Rate limits applied at execution. âœ…
- Liquidity check (LOCKED_BALANCES) for LockUnlock. âœ…

### 3.3 Cancel Window (Fixed)

**Previously:** Cancel window was hardcoded to 300s while query used configurable WITHDRAW_DELAY.

**Remediation:** Execute logic now loads `WITHDRAW_DELAY` from storage in `execute_withdraw_cancel` and `load_and_validate_execution`. Single source of truth for cancel window duration.

---

## 4. Top Common Smart Contract Issues (CosmWasm)

### 4.1 Reentrancy

- CosmWasm executes messages atomically; no async callbacks into the same contract mid-execution.
- CW20 `Transfer`/`Mint` and Bank `Send` are the final sub-messages; no callback re-entry.

**Verdict:** âœ… Reentrancy risk is low in this architecture.

### 4.2 Integer Overflow / Underflow

- Uses `Uint128` and `checked_mul` where applicable (e.g., `normalize_decimals`).
- One `unwrap_or(Uint128::MAX)` in `normalize_decimals` when scaling upâ€”edge case if `amount * multiplier` overflows; consider `checked_mul` and explicit error.

**Verdict:** âœ… Generally safe; minor hardening possible.

### 4.3 Unchecked External Calls

- CW20 and Bank messages are constructed and sent; CosmWasm handles failures at the chain level.
- No low-level `call` equivalent that could silently fail.

**Verdict:** âœ… No issues identified.

### 4.4 Front-Running

- Deposit: user submits; no auction. Operator sees pending withdrawals and approves.
- Withdraw execution: anyone can execute after the window; first successful tx wins. No obvious front-run profit beyond gas competition.

**Verdict:** âœ… No critical front-running vectors.

### 4.5 Centralization / Trust

- Admin: pause, recovery, chain/token config, operators, cancelers.
- Operator: approves withdrawals (trust that source chain deposit exists).
- Canceler: can cancel within window.
- Recovery requires pause; admin can drain stuck assets when paused.

**Verdict:** âš ï¸ Inherent to bridge design; document and monitor.

### 4.6 Input Validation

- Chain IDs: 4 bytes; `0x00000000` rejected. âœ…
- Token mappings validated. âœ…
- Hash lengths: 32 bytes for xchain_hash_id. âœ…
- Amount > 0 for WithdrawSubmit. âœ…
- Recipient address validated. âœ…

**Verdict:** âœ… Input validation is adequate.

---

## 5. Specific Findings

### 5.1 WithdrawDelay Validation Mismatch (Fixed)

- `execute_set_withdraw_delay` validates `15..=86400`.
- Error `InvalidWithdrawDelay` message updated to "must be between 15 and 86400 seconds".

### 5.2 Operator Approves Without Verification

- `WithdrawApprove` does not verify that the deposit exists on the source chain.
- Operator is trusted to have verified off-chain (e.g., via indexer or RPC).
- This is by design for watchtower; ensure operator infra is robust.

### 5.3 MintBurn Execution â€“ CW20 Mint Permissions (Documented)

- `WithdrawExecuteMint` sends `Cw20ExecuteMsg::Mint` to the token contract.
- The bridge must have `minter` role on the CW20 mintable contract.
- **Remediation:** Documented in `docs/OPERATIONAL_NOTES.md` (mint capability lifecycle).

### 5.4 Rate Limit Default for Zero Supply (Documented)

- When no rate limit is configured, fallback uses `0.1% of supply` or `100 ether` if supply is zero.
- **Remediation:** Build with `--features cosmwasm_1_2` for production to enable BankQuery::Supply for native token supply. Fallback behavior and deployment notes documented in `docs/OPERATIONAL_NOTES.md`.

---

## 6. Recommendations Summary

| Priority | Item | Status |
|----------|------|--------|
| **P0** | Fix cancel window: use `WITHDRAW_DELAY` in execute logic instead of hardcoded 300. | âœ… Done |
| **P1** | Restrict `WithdrawCancel` to cancelers only (remove operator/admin). | âœ… Done |
| **P1** | Restrict `SetCustomAccountFee`/`RemoveCustomAccountFee` to admin only. | âœ… Done |
| **P2** | Add tests: full deposit flow (limits, fees), RecoverAsset. | âœ… Done |
| **P2** | Add test for `WithdrawExecuteMint` (wrong token type). | âœ… Done |
| **P2** | Align `InvalidWithdrawDelay` error message with validation range. | âœ… Done |
| **P3** | Document admin-as-operator and canceler-as-separate-role design decisions. | âœ… Done (`docs/OPERATIONAL_NOTES.md`) |
| **P3** | Consider deposit-side rate limits for symmetry. | ðŸ“‹ Future |

---

## 7. Appendix: Message â†’ Access Matrix

| ExecuteMsg | Admin | Operator | Canceler | Public |
|------------|-------|----------|----------|--------|
| DepositNative, Receive | | | | âœ… |
| WithdrawSubmit | | | | âœ… |
| WithdrawApprove | âœ… | âœ… | | |
| WithdrawCancel | | | âœ… | |
| WithdrawUncancel | âœ… | âœ… | | |
| WithdrawExecuteUnlock, Mint | | | | âœ… |
| AddCanceler, RemoveCanceler | âœ… | | | |
| SetWithdrawDelay | âœ… | | | |
| SetRateLimit | âœ… | | | |
| RegisterChain, UnregisterChain, UpdateChain | âœ… | | | |
| AddToken, UpdateToken, SetTokenDestination | âœ… | | | |
| SetIncomingTokenMapping, RemoveIncomingTokenMapping | âœ… | | | |
| SetAllowedCw20CodeIds | âœ… | | | |
| AddOperator, RemoveOperator, UpdateMinSignatures | âœ… | | | |
| UpdateLimits, UpdateFees, SetFeeParams | âœ… | | | |
| SetCustomAccountFee, RemoveCustomAccountFee | âœ… | | | |
| Pause, Unpause | âœ… | | | |
| ProposeAdmin, AcceptAdmin, CancelAdminProposal | âœ… (Accept: pending admin) | | | |
| RecoverAsset | âœ… (when paused) | | | |

---

## Appendix: Later Review

For a more recent review that addresses deposit flow tests, RecoverAsset tests, rate limit enforcement, and migration/v1 documentation, see:

- [SECURITY_REVIEW_20260211_070059.md](./SECURITY_REVIEW_20260211_070059.md)

---

*End of Security Review*
