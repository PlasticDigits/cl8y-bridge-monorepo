# Security Review: contracts-terraclassic Package

**Date:** 2026-02-11 (UTC)  
**Epoch:** 20260211_070059  
**Reviewer:** Security Review  
**Package:** `packages/contracts-terraclassic` (bridge CosmWasm contract)

---

## Executive Summary

This document provides a comprehensive security review of the contracts-terraclassic package. The bridge is a CosmWasm contract implementing a cross-chain asset transfer system with user-initiated withdrawals, operator approvals, and a canceler role (watchtower pattern). It runs on Terra Classic and interfaces with EVM chains.

### Key Findings Summary

| Severity | Count | Summary |
|----------|-------|---------|
| High | 0 | — |
| Medium | 0 | — |
| Low/Info | 5 | Recommendations and hardening opportunities |

---

## 1. Test Coverage

### 1.1 Coverage Overview

- **Total test files:** 7
- **Test areas:** Withdraw flow, integration, chain registry, incoming token registry, fee system, hash parity, address codec

### 1.2 Per-Module Test Status

| Module/Flow | Tests | Status |
|-------------|-------|--------|
| Withdraw flow (V2) | 24 tests | ✅ Excellent – full lifecycle, cancel/uncancel, rate limit, decimal normalization |
| Integration | 17 tests | ✅ Good – instantiation, submit/approve/cancel/execute |
| Chain registry | Multiple | ✅ Good – register, unregister, enable/disable |
| Incoming token registry | 19 tests | ✅ Good – mapping, validation |
| Fee system | Multiple | ✅ Adequate |
| Hash parity | Multiple | ✅ Excellent – cross-chain hash consistency |
| Address codec | Unit tests | ✅ Adequate |

### 1.3 Test Coverage Gaps

1. **Deposit flows under-tested** – Limited tests for `DepositNative` min/max limits, fee calculation edge cases, or CW20 deposit (lock/burn) with full flow verification.

2. **Admin/recovery flows** – No explicit tests for `RecoverAsset` amount validation or paused-state behavior when recovering.

3. **Rate limit enforcement** – `test_full_withdraw_cycle_with_liquidity` and `test_withdraw_decimal_normalization_18_to_6` exercise rate limits; no dedicated negative tests for exceeding per-transaction or per-period limits.

4. **Migration** – No tests for `migrate` entry point. **Not needed:** v1 was never deployed; bridge launched as v2. Documented in `docs/OPERATIONAL_NOTES.md`.

5. **RecoverAsset** – Tests added for native success and validation. CW20 recovery covered in integration tests.

---

## 2. Access Control (RBAC)

### 2.1 RBAC Model (per implementation)

| Role | Permissions |
|------|-------------|
| Admin | System variables, chain/token registration, pause, operators, cancelers, RecoverAsset, custom fees |
| Operator | `WithdrawApprove`, `WithdrawUncancel` (admin also allowed as backup) |
| Canceler | `WithdrawCancel` only |
| Public | Deposit, WithdrawSubmit, WithdrawExecuteUnlock, WithdrawExecuteMint |

### 2.2 Implemented Access Control

| Message | Restricted To | Status |
|---------|---------------|--------|
| Pause / Unpause | Admin | ✅ |
| RegisterChain, AddToken, etc. | Admin | ✅ |
| AddCanceler / RemoveCanceler | Admin | ✅ |
| SetWithdrawDelay, SetRateLimit | Admin | ✅ |
| AddOperator / RemoveOperator | Admin | ✅ |
| UpdateLimits, UpdateFees, SetFeeParams | Admin | ✅ |
| **WithdrawApprove** | Operator or Admin | ✅ (by design – admin backup) |
| **WithdrawUncancel** | Operator or Admin | ✅ |
| **WithdrawCancel** | Canceler only | ✅ |
| **SetCustomAccountFee** | Admin only | ✅ |
| **RemoveCustomAccountFee** | Admin only | ✅ |
| DepositNative, Receive | Public | ✅ |
| WithdrawSubmit | Public | ✅ |
| WithdrawExecuteUnlock / Mint | Public | ✅ |

### 2.3 Note on msg.rs Comments

The `ExecuteMsg` enum docs in `msg.rs` incorrectly state that `SetCustomAccountFee` and `RemoveCustomAccountFee` are "operator only". The actual implementation restricts them to admin. **Recommendation:** Update the doc comments in `msg.rs` to say "Admin only".

---

## 3. Flows

### 3.1 Deposit Flow (Outgoing)

1. User calls `DepositNative` or sends CW20 via `Receive(DepositCw20Lock/DepositCw20MintableBurn)`.
2. Contract validates: paused, chain, token, amount limits, fee calculation.
3. Tokens are locked (LockUnlock) or burned (MintBurn); fee sent to collector; deposit hash stored.
4. Nonce incremented; transaction and deposit info persisted.

**Observations:**
- Amount limits (`min_bridge_amount`, `max_bridge_amount`) enforced. ✅
- Fee uses V2 fee manager (CL8Y discount, custom account fees). ✅
- CW20 receive path validates token via `TOKENS.may_load` and token type (LockUnlock vs MintBurn). ✅
- No rate limit on deposits; only withdrawals are rate-limited. **By design:** rate limits mitigate asset loss during security incidents (e.g., fraudulent approvals); deposits do not have this attack vector. Documented in `docs/OPERATIONAL_NOTES.md`.

### 3.2 Withdrawal Flow (V2 – Incoming)

1. **WithdrawSubmit** – User submits params; creates `PendingWithdraw`; optional operator gas tip in uluna.
2. **WithdrawApprove** – Operator (or admin) approves; marks nonce used; starts cancel window; transfers operator gas to approver.
3. **WithdrawCancel** – Canceler cancels within cancel window.
4. **WithdrawUncancel** – Operator (or admin) restores cancelled withdrawal and resets cancel window.
5. **WithdrawExecuteUnlock / WithdrawExecuteMint** – Anyone executes after cancel window; releases tokens.

**Observations:**
- Nonce reuse prevented via `WITHDRAW_NONCE_USED`. ✅
- Cancel window uses `WITHDRAW_DELAY` consistently in both cancel and execute logic. ✅
- Rate limits applied at execution (per-transaction and per-period). ✅
- Liquidity check (LOCKED_BALANCES) for LockUnlock. ✅

### 3.3 Cancel Window

Cancel window is read from `WITHDRAW_DELAY` in both `execute_withdraw_cancel` and `load_and_validate_execution`. Single source of truth. ✅

---

## 4. Top Common Smart Contract Issues (CosmWasm)

### 4.1 Reentrancy

- CosmWasm executes messages atomically; no async callbacks into the same contract mid-execution.
- CW20 `Transfer`/`Mint`/`Burn` and Bank `Send` are sub-messages; no callback re-entry.

**Verdict:** ✅ Reentrancy risk is low.

### 4.2 Integer Overflow / Underflow

- Uses `Uint128` and `checked_mul` in `normalize_decimals` where applicable.
- One `unwrap_or(Uint128::MAX)` in `normalize_decimals` when scaling up; edge case if `amount * multiplier` overflows. **Recommendation:** Use `checked_mul` and return an explicit error instead of clamping to MAX.

**Verdict:** ✅ Generally safe; minor hardening possible.

### 4.3 Unchecked External Calls

- CW20 and Bank messages constructed and sent; CosmWasm handles failures at chain level.
- No low-level `call` equivalent that could silently fail.

**Verdict:** ✅ No issues identified.

### 4.4 Front-Running

- Deposit: user submits; no auction.
- Withdraw execution: anyone can execute after window; first successful tx wins. No obvious front-run profit beyond gas competition.

**Verdict:** ✅ No critical front-running vectors.

### 4.5 Centralization / Trust

- Admin: pause, recovery, chain/token config, operators, cancelers.
- Operator: approves withdrawals without on-chain verification of source-chain deposit.
- Canceler: can cancel within window.
- Recovery requires pause; admin can drain stuck assets when paused.

**Verdict:** ⚠️ Inherent to bridge design; documented in `docs/OPERATIONAL_NOTES.md`.

### 4.6 Input Validation

- Chain IDs: 4 bytes; `0x00000000` rejected. ✅
- Token mappings validated. ✅
- Hash lengths: 32 bytes for xchain_hash_id. ✅
- Amount > 0 for WithdrawSubmit. ✅
- Recipient address validated. ✅

**Verdict:** ✅ Input validation is adequate.

---

## 5. Specific Findings

### 5.1 RecoverAsset – No Amount Bound Check (Low)

- `execute_recover_asset` allows admin to specify any `amount` when recovering.
- For native tokens, `BankMsg::Send` sends from contract balance; insufficient balance causes tx failure.
- For CW20, `Transfer` fails if contract holds less than `amount`.
- **Conclusion:** Safe by virtue of submessage failure; no change needed. Documented for completeness.

### 5.2 Operator Approves Without On-Chain Verification

- `WithdrawApprove` does not verify that the deposit exists on the source chain.
- Operator is trusted to have verified off-chain (e.g., via indexer or RPC).
- This is by design for watchtower; ensure operator infra is robust.

### 5.3 MintBurn Execution – CW20 Mint Permissions

- `WithdrawExecuteMint` sends `Cw20ExecuteMsg::Mint` to the token contract.
- The bridge must have `minter` role on the CW20 mintable contract.
- Documented in `docs/OPERATIONAL_NOTES.md`.

### 5.4 Rate Limit Default for Zero Supply

- When no rate limit is configured, fallback uses `0.1% of supply` or `100 ether` if supply is zero.
- Build with `--features cosmwasm_1_2` for production to enable `BankQuery::Supply` for native tokens.
- Documented in `docs/OPERATIONAL_NOTES.md`.

### 5.5 normalize_decimals Overflow (Fixed)

- Previously: On overflow, amount was clamped to MAX instead of failing.
- **Remediation:** Uses Uint256/Uint512 for intermediate computation; returns `ContractError::AmountOverflow` and fails the tx when result exceeds Uint128. Added tests for 18-decimal tokens with quadrillion+ quantities.

---

## 6. Recommendations Summary

| Priority | Item | Status |
|----------|------|--------|
| **P0** | None | — |
| **P1** | Fix `normalize_decimals` overflow handling: return error instead of clamping to MAX | ✅ Done |
| **P2** | Update `msg.rs` doc comments: SetCustomAccountFee/RemoveCustomAccountFee → "Admin only" | ✅ Done |
| **P2** | Add tests: RecoverAsset, rate limit negative cases | ✅ Done |
| **P3** | Consider deposit-side rate limits | N/A – Rate limits are for withdrawal asset-loss mitigation; deposits not in scope. Documented in `docs/OPERATIONAL_NOTES.md`. |

---

## 7. Appendix: Message → Access Matrix

| ExecuteMsg | Admin | Operator | Canceler | Public |
|------------|-------|----------|----------|--------|
| DepositNative, Receive | | | | ✅ |
| WithdrawSubmit | | | | ✅ |
| WithdrawApprove | ✅ | ✅ | | |
| WithdrawCancel | | | ✅ | |
| WithdrawUncancel | ✅ | ✅ | | |
| WithdrawExecuteUnlock, Mint | | | | ✅ |
| AddCanceler, RemoveCanceler | ✅ | | | |
| SetWithdrawDelay | ✅ | | | |
| SetRateLimit | ✅ | | | |
| RegisterChain, UnregisterChain, UpdateChain | ✅ | | | |
| AddToken, UpdateToken, SetTokenDestination | ✅ | | | |
| SetIncomingTokenMapping, RemoveIncomingTokenMapping | ✅ | | | |
| SetAllowedCw20CodeIds | ✅ | | | |
| AddOperator, RemoveOperator, UpdateMinSignatures | ✅ | | | |
| UpdateLimits, UpdateFees, SetFeeParams | ✅ | | | |
| SetCustomAccountFee, RemoveCustomAccountFee | ✅ | | | |
| Pause, Unpause | ✅ | | | |
| ProposeAdmin, AcceptAdmin, CancelAdminProposal | ✅ (Accept: pending admin) | | | |
| RecoverAsset | ✅ (when paused) | | | |

---

*End of Security Review*
