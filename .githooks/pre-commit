#!/bin/bash
# =============================================================================
# CL8Y Bridge Pre-commit Hook
# =============================================================================
# SECURITY: This bridge handles cross-chain assets.
# ALL checks run on EVERY commit. No exceptions. No skipping.
#
# Checks:
#   1. Formatting (Rust + Solidity) - ALL packages
#   2. Clippy linting (Rust) - ALL packages  
#   3. Secret detection (gitleaks)
#   4. Full E2E tests (starts infra, runs tests, tears down)
#
# Install: git config core.hooksPath .githooks
# Skip: git commit --no-verify (NOT RECOMMENDED - security risk)
#
# NOTE: This hook runs FULL E2E tests. Commits will take 10-30+ minutes.
# =============================================================================

set -e

# Get the repo root
REPO_ROOT=$(git rev-parse --show-toplevel)

# Track overall success
CHECKS_PASSED=true

echo "============================================================"
echo "  CL8Y Bridge Pre-commit Security Checks"
echo "  ALL checks run on EVERY commit. No skipping."
echo "============================================================"

# ==============================================================================
# FORMATTING CHECKS - ALL PACKAGES, ALWAYS
# ==============================================================================

echo ""
echo "üîß Checking code formatting (ALL packages)..."

# Operator
if command -v cargo &> /dev/null; then
    echo "  ‚Üí Checking operator (Rust fmt)..."
    if ! (cd "$REPO_ROOT/packages/operator" && cargo fmt --check 2>/dev/null); then
        echo "‚ùå Operator has formatting issues. Run: cd packages/operator && cargo fmt"
        CHECKS_PASSED=false
    else
        echo "    ‚úì operator formatted"
    fi
fi

# Canceler
if command -v cargo &> /dev/null; then
    echo "  ‚Üí Checking canceler (Rust fmt)..."
    if ! (cd "$REPO_ROOT/packages/canceler" && cargo fmt --check 2>/dev/null); then
        echo "‚ùå Canceler has formatting issues. Run: cd packages/canceler && cargo fmt"
        CHECKS_PASSED=false
    else
        echo "    ‚úì canceler formatted"
    fi
fi

# Terra contracts
if command -v cargo &> /dev/null; then
    echo "  ‚Üí Checking Terra contracts (Rust fmt)..."
    if ! (cd "$REPO_ROOT/packages/contracts-terraclassic/bridge" && cargo fmt --check 2>/dev/null); then
        echo "‚ùå Terra contracts have formatting issues. Run: cd packages/contracts-terraclassic/bridge && cargo fmt"
        CHECKS_PASSED=false
    else
        echo "    ‚úì terra contracts formatted"
    fi
fi

# EVM contracts
if command -v forge &> /dev/null; then
    echo "  ‚Üí Checking EVM contracts (Solidity fmt)..."
    if ! (cd "$REPO_ROOT/packages/contracts-evm" && forge fmt --check src/ script/ test/ 2>/dev/null); then
        echo "‚ùå EVM contracts have formatting issues. Run: cd packages/contracts-evm && forge fmt"
        CHECKS_PASSED=false
    else
        echo "    ‚úì evm contracts formatted"
    fi
fi

# ==============================================================================
# CLIPPY CHECKS - ALL PACKAGES, ALWAYS
# ==============================================================================

echo ""
echo "üîç Running clippy (ALL Rust packages)..."

# Operator
if command -v cargo &> /dev/null; then
    echo "  ‚Üí Checking operator (clippy)..."
    if ! (cd "$REPO_ROOT/packages/operator" && cargo clippy --quiet -- -D warnings 2>&1); then
        echo "‚ùå Operator has clippy warnings. Run: cd packages/operator && cargo clippy -- -D warnings"
        CHECKS_PASSED=false
    else
        echo "    ‚úì operator clippy clean"
    fi
fi

# Canceler
if command -v cargo &> /dev/null; then
    echo "  ‚Üí Checking canceler (clippy)..."
    if ! (cd "$REPO_ROOT/packages/canceler" && cargo clippy --quiet -- -D warnings 2>&1); then
        echo "‚ùå Canceler has clippy warnings. Run: cd packages/canceler && cargo clippy -- -D warnings"
        CHECKS_PASSED=false
    else
        echo "    ‚úì canceler clippy clean"
    fi
fi

# Terra contracts
if command -v cargo &> /dev/null; then
    echo "  ‚Üí Checking Terra contracts (clippy)..."
    if ! (cd "$REPO_ROOT/packages/contracts-terraclassic/bridge" && cargo clippy --quiet -- -D warnings 2>&1); then
        echo "‚ùå Terra contracts have clippy warnings. Run: cd packages/contracts-terraclassic/bridge && cargo clippy -- -D warnings"
        CHECKS_PASSED=false
    else
        echo "    ‚úì terra contracts clippy clean"
    fi
fi

# ==============================================================================
# SECRET DETECTION
# ==============================================================================

echo ""
echo "üîç Checking for secrets..."

if ! command -v gitleaks &> /dev/null; then
    echo "‚ö†Ô∏è  gitleaks is not installed. Skipping secret detection."
    echo "   Install: brew install gitleaks (macOS) or sudo apt install gitleaks"
else
    if ! gitleaks protect --staged --config .gitleaks.toml --verbose; then
        echo ""
        echo "‚ùå Gitleaks found potential secrets in your staged changes!"
        CHECKS_PASSED=false
    else
        echo "    ‚úì no secrets detected"
    fi
fi

# ==============================================================================
# E2E TESTS - FULL SUITE WITH SETUP AND TEARDOWN
# ==============================================================================

echo ""
echo "üß™ Running FULL E2E test suite..."
echo "   This includes: infrastructure setup, all tests, teardown"
echo "   Expected time: 10-30 minutes"
echo ""

cd "$REPO_ROOT"
if ! make e2e-test; then
    echo ""
    echo "‚ùå E2E tests failed!"
    CHECKS_PASSED=false
else
    echo "    ‚úì all E2E tests passed"
fi

# ==============================================================================
# FINAL RESULT
# ==============================================================================

echo ""
echo "============================================================"

if [ "$CHECKS_PASSED" = false ]; then
    echo "‚ùå PRE-COMMIT CHECKS FAILED"
    echo ""
    echo "Fix the issues above, then stage your changes and try again."
    echo "To skip checks (NOT RECOMMENDED - security risk): git commit --no-verify"
    echo "============================================================"
    exit 1
fi

echo "‚úÖ ALL PRE-COMMIT CHECKS PASSED"
echo "============================================================"
