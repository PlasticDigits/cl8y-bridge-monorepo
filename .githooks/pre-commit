#!/usr/bin/env bash
# Pre-commit hook: runs cargo audit on Rust packages with staged changes.
#
# Install:
#   git config core.hooksPath .githooks
# Or symlink:
#   ln -sf ../../.githooks/pre-commit .git/hooks/pre-commit

set -euo pipefail

RUST_PACKAGES=(
    "packages/operator"
    "packages/canceler"
    "packages/multichain-rs"
)

audit_failed=0

for pkg in "${RUST_PACKAGES[@]}"; do
    # Only audit packages that have staged changes
    if git diff --cached --name-only | grep -q "^${pkg}/"; then
        echo "üîí Running cargo audit on ${pkg}..."
        if ! (cd "${pkg}" && cargo audit); then
            echo "‚ùå cargo audit failed for ${pkg}"
            audit_failed=1
        else
            echo "‚úÖ ${pkg} passed cargo audit"
        fi
    fi
done

if [ "$audit_failed" -ne 0 ]; then
    echo ""
    echo "Commit blocked: cargo audit found vulnerabilities."
    echo "Fix the issues above, or update .cargo/audit.toml to ignore with justification."
    exit 1
fi
