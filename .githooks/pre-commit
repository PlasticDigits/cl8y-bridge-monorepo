#!/bin/bash
# Pre-commit hook for:
#   1. Formatting checks (Rust + Solidity)
#   2. Clippy linting (Rust)
#   3. Secret detection (gitleaks)
#
# Install: git config core.hooksPath .githooks
# Skip: git commit --no-verify (not recommended)
#
# Environment variables:
#   SKIP_CLIPPY=1 - Skip clippy checks (faster commits, but CI may still fail)

set -e

# Get the repo root
REPO_ROOT=$(git rev-parse --show-toplevel)

# Track overall success
CHECKS_PASSED=true

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# ==============================================================================
# FORMATTING CHECKS
# ==============================================================================

echo "üîß Checking code formatting..."

# Check if any Rust files in operator are staged
if echo "$STAGED_FILES" | grep -q "^packages/operator/"; then
    if command -v cargo &> /dev/null; then
        echo "  ‚Üí Checking operator (Rust fmt)..."
        if ! (cd "$REPO_ROOT/packages/operator" && cargo fmt --check 2>/dev/null); then
            echo "‚ùå Operator has formatting issues. Run: cd packages/operator && cargo fmt"
            CHECKS_PASSED=false
        fi
    fi
fi

# Check if any Rust files in canceler are staged
if echo "$STAGED_FILES" | grep -q "^packages/canceler/"; then
    if command -v cargo &> /dev/null; then
        echo "  ‚Üí Checking canceler (Rust fmt)..."
        if ! (cd "$REPO_ROOT/packages/canceler" && cargo fmt --check 2>/dev/null); then
            echo "‚ùå Canceler has formatting issues. Run: cd packages/canceler && cargo fmt"
            CHECKS_PASSED=false
        fi
    fi
fi

# Check if any Rust files in terra contracts are staged (check workspace and bridge/)
if echo "$STAGED_FILES" | grep -q "^packages/contracts-terraclassic/"; then
    if command -v cargo &> /dev/null; then
        echo "  ‚Üí Checking Terra contracts (Rust fmt)..."
        if ! (cd "$REPO_ROOT/packages/contracts-terraclassic/bridge" && cargo fmt --check 2>/dev/null); then
            echo "‚ùå Terra contracts have formatting issues. Run: cd packages/contracts-terraclassic/bridge && cargo fmt"
            CHECKS_PASSED=false
        fi
    fi
fi

# Check if any Solidity files in EVM contracts are staged
if echo "$STAGED_FILES" | grep -q "^packages/contracts-evm/"; then
    if command -v forge &> /dev/null; then
        echo "  ‚Üí Checking EVM contracts (Solidity fmt)..."
        # Only check src/, script/, test/ - not lib/
        if ! (cd "$REPO_ROOT/packages/contracts-evm" && forge fmt --check src/ script/ test/ 2>/dev/null); then
            echo "‚ùå EVM contracts have formatting issues. Run: cd packages/contracts-evm && forge fmt"
            CHECKS_PASSED=false
        fi
    fi
fi

# ==============================================================================
# CLIPPY CHECKS (Rust linting - matches CI)
# ==============================================================================

if [ "$SKIP_CLIPPY" = "1" ]; then
    echo "‚ö†Ô∏è  Skipping clippy checks (SKIP_CLIPPY=1)"
else
    echo "üîç Running clippy (Rust linting)..."
    
    # Check operator
    if echo "$STAGED_FILES" | grep -q "^packages/operator/"; then
        if command -v cargo &> /dev/null; then
            echo "  ‚Üí Checking operator (clippy)..."
            if ! (cd "$REPO_ROOT/packages/operator" && cargo clippy -- -D warnings 2>&1 | tail -5); then
                echo "‚ùå Operator has clippy warnings. Run: cd packages/operator && cargo clippy -- -D warnings"
                CHECKS_PASSED=false
            fi
        fi
    fi
    
    # Check canceler
    if echo "$STAGED_FILES" | grep -q "^packages/canceler/"; then
        if command -v cargo &> /dev/null; then
            echo "  ‚Üí Checking canceler (clippy)..."
            if ! (cd "$REPO_ROOT/packages/canceler" && cargo clippy -- -D warnings 2>&1 | tail -5); then
                echo "‚ùå Canceler has clippy warnings. Run: cd packages/canceler && cargo clippy -- -D warnings"
                CHECKS_PASSED=false
            fi
        fi
    fi
    
    # Check terra contracts (check workspace and bridge/)
    if echo "$STAGED_FILES" | grep -q "^packages/contracts-terraclassic/"; then
        if command -v cargo &> /dev/null; then
            echo "  ‚Üí Checking Terra contracts (clippy)..."
            if ! (cd "$REPO_ROOT/packages/contracts-terraclassic/bridge" && cargo clippy -- -D warnings 2>&1 | tail -5); then
                echo "‚ùå Terra contracts have clippy warnings. Run: cd packages/contracts-terraclassic/bridge && cargo clippy -- -D warnings"
                CHECKS_PASSED=false
            fi
        fi
    fi
fi

# ==============================================================================
# SECRET DETECTION
# ==============================================================================

echo "üîç Checking for secrets..."

# Check if gitleaks is installed
if ! command -v gitleaks &> /dev/null; then
    echo "‚ö†Ô∏è  gitleaks is not installed. Skipping secret detection."
    echo ""
    echo "Install gitleaks using one of these methods:"
    echo "  brew install gitleaks              # macOS"
    echo "  sudo apt install gitleaks          # Debian/Ubuntu"
    echo "  cargo install gitleaks             # via Cargo"
    echo "  go install github.com/gitleaks/gitleaks/v8@latest  # via Go"
    echo ""
else
    # Run gitleaks on staged changes only
    if ! gitleaks protect --staged --config .gitleaks.toml --verbose; then
        echo ""
        echo "‚ùå Gitleaks found potential secrets in your staged changes!"
        echo ""
        echo "Please review the findings above and either:"
        echo "  1. Remove the secret from the code"
        echo "  2. Add a legitimate exception to .gitleaks.toml if it's a false positive"
        CHECKS_PASSED=false
    fi
fi

# ==============================================================================
# FINAL RESULT
# ==============================================================================

if [ "$CHECKS_PASSED" = false ]; then
    echo ""
    echo "‚ùå Pre-commit checks failed!"
    echo ""
    echo "Fix the issues above, then stage your changes and try again."
    echo "To skip checks (not recommended): git commit --no-verify"
    exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
